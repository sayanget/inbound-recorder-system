# 数据库备份功能使用说明

## 功能介绍

该功能可以每天自动压缩主数据库文件(`inbound.db`)并通过邮件发送到指定邮箱，确保数据安全。

### 主要功能
1. **自动数据库压缩**：使用ZIP格式压缩数据库文件，节省存储空间
2. **邮件发送**：自动发送带压缩附件的HTML格式邮件
3. **定时任务**：可配置每天固定时间自动执行备份
4. **智能附件处理**：自动检测附件大小，超过限制时发送通知邮件

### 备份内容
- 完整的数据库文件(`inbound.db`)
- 压缩后的文件名格式：`inbound_backup_YYYYMMDD.zip`
- 邮件包含：数据库记录数、文件大小、压缩率等信息

---

## 配置步骤

### 1. 邮箱配置

编辑 `email_config.py` 文件（如果不存在，请复制 `email_config.example.py` 为 `email_config.py`），添加以下配置：

```python
# ==================== 数据库备份配置 ====================

# 数据库备份发送时间 (24小时制, 格式: "HH:MM")
BACKUP_TIME = "02:00"  # 默认凌晨2点备份

# 是否在发送后删除本地备份压缩文件
DELETE_BACKUP_FILE = False  # False=保留本地备份，True=删除

# 数据库备份邮件主题前缀
BACKUP_EMAIL_SUBJECT_PREFIX = "数据库备份"

# 邮件附件最大大小限制 (MB)
MAX_ATTACHMENT_SIZE_MB = 25  # 超过此大小将不附加文件
```

### 2. 基本邮箱配置

确保 `email_config.py` 中已配置好基本邮箱信息：

```python
SMTP_SERVER = "smtp.gmail.com"
SMTP_PORT = 587
SENDER_EMAIL = "your_email@gmail.com"
SENDER_PASSWORD = "your_app_password"
RECIPIENT_EMAIL = "sayanget@yahoo.com"
```

---

## 使用方法

### 方法一：立即测试备份

双击运行 `测试数据库备份.bat`，这将：
- 立即压缩数据库文件
- 发送测试邮件到指定邮箱
- 显示压缩信息和发送结果

### 方法二：启动定时任务

双击运行 `启动数据库备份服务.bat`，程序将：
- 在后台持续运行
- 每天在配置的时间自动执行备份
- 按 `Ctrl+C` 可停止服务

### 方法三：命令行运行

```bash
# 立即执行一次完整备份测试
python db_backup_service.py --test

# 仅测试压缩功能
python db_backup_service.py --test-compress

# 仅测试邮件发送功能
python db_backup_service.py --test-email

# 启动定时任务（持续运行）
python db_backup_service.py
```

---

## 邮件内容示例

### 邮件主题
```
数据库备份 - 2025年12月30日
```

### 邮件正文
包含：
- 💾 备份日期
- 📊 数据库信息（记录总数、文件大小、压缩率等）
- ✅ 备份成功提示
- 📎 压缩文件作为附件

### 附件
- 文件名：`inbound_backup_20251230.zip`
- 内容：完整的 `inbound.db` 数据库文件
- 可直接解压使用

---

## 配置说明

### 备份时间设置

建议设置在业务低峰期，例如：
- `"02:00"` - 凌晨2点（推荐）
- `"23:00"` - 晚上11点
- `"12:00"` - 中午12点

### 文件保留策略

**DELETE_BACKUP_FILE = False（推荐）**
- 优点：本地保留备份副本，双重保险
- 缺点：占用磁盘空间
- 适用：磁盘空间充足的情况

**DELETE_BACKUP_FILE = True**
- 优点：节省磁盘空间
- 缺点：仅依赖邮件备份
- 适用：磁盘空间紧张的情况

### 附件大小限制

不同邮箱服务商的附件限制：
- Gmail: 25 MB
- Yahoo: 25 MB
- Outlook: 20 MB
- QQ邮箱: 50 MB

如果数据库文件压缩后超过限制，系统会：
1. 发送不带附件的通知邮件
2. 在邮件中说明文件位置
3. 保留本地压缩文件

---

## 常见问题

### Q1: 如何查看备份是否成功？

**A:** 有以下几种方式：
1. 查看控制台输出（如果程序在前台运行）
2. 检查邮箱是否收到备份邮件
3. 查看项目目录下是否生成了 `inbound_backup_YYYYMMDD.zip` 文件

### Q2: 备份文件可以直接使用吗？

**A:** 可以。下载邮件附件后：
1. 解压 ZIP 文件
2. 得到 `inbound.db` 文件
3. 可直接替换现有数据库文件使用

### Q3: 如何恢复数据库？

**A:** 数据恢复步骤：
1. 停止正在运行的应用程序
2. 备份当前的 `inbound.db` 文件
3. 从邮件附件下载并解压备份文件
4. 用解压出的 `inbound.db` 替换现有文件
5. 重新启动应用程序

### Q4: 可以同时运行数据报告和数据库备份吗？

**A:** 可以。建议：
- 数据报告：每天早上8点发送（`daily_email_report.py`）
- 数据库备份：每天凌晨2点发送（`db_backup_service.py`）
- 两个服务可以同时运行，互不影响

### Q5: 压缩率大概是多少？

**A:** 通常情况下：
- SQLite数据库压缩率约为 50-70%
- 例如：150KB 的数据库压缩后约为 50-75KB
- 具体压缩率取决于数据内容

### Q6: 如何设置开机自动启动？

**A:** 使用Windows任务计划程序：
1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：选择"计算机启动时"
4. 操作：启动程序
5. 程序：`python`
6. 参数：`db_backup_service.py`
7. 起始于：`D:\project\inbound_python_source`

### Q7: 邮件发送失败怎么办？

**A:** 检查以下几点：
1. 邮箱配置是否正确（特别是应用专用密码）
2. 网络连接是否正常
3. SMTP服务器和端口是否正确
4. 是否开启了邮箱的SMTP服务
5. 查看控制台错误信息

---

## 安全建议

1. **定期检查备份**：每周检查一次邮箱，确保收到备份邮件
2. **多重备份**：建议同时保留本地备份和邮件备份
3. **测试恢复**：定期测试备份文件是否可以正常恢复
4. **保护邮箱**：确保接收备份的邮箱安全可靠
5. **监控磁盘空间**：如果保留本地备份，注意定期清理旧文件

---

## 文件说明

- `db_backup_service.py` - 数据库备份主程序
- `email_config.py` - 邮箱配置文件（需自行创建）
- `email_config.example.py` - 配置文件示例
- `启动数据库备份服务.bat` - 启动定时任务
- `测试数据库备份.bat` - 测试备份功能
- `README_DB_BACKUP.md` - 本说明文档
- `inbound.db` - 主数据库文件
- `inbound_backup_YYYYMMDD.zip` - 生成的备份文件

---

## 技术支持

如有问题，请检查：
1. Python版本（建议3.7+）
2. 依赖包是否安装（sqlite3, zipfile, smtplib, schedule等）
3. 数据库文件路径是否正确
4. 邮箱配置是否正确

---

## 更新日志

### v1.0 (2025-12-30)
- 初始版本
- 支持自动数据库压缩
- 支持邮件发送备份文件
- 支持定时任务
- 支持附件大小检测
- 支持命令行测试模式
