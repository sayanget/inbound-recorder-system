<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="statistics_title">入库统计</title>
    <link rel="icon" type="image/x-icon" href="/static/in0.ico">
    <!-- 添加Chart.js核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 添加Chart.js数据标签插件 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --info-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: #dee2e6;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        /* User info display */
        .user-info {
            position: absolute;
            top: 15px;
            right: 120px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .user-info button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #usernameDisplay {
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        #logoutBtn {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Language selector dropdown */
        .language-selector {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
        }

        .lang-dropdown {
            position: relative;
            display: inline-block;
        }

        .lang-selected {
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lang-selected:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .lang-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 120px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            border-radius: 4px;
            overflow: hidden;
        }

        .lang-dropdown-content.show {
            display: block;
        }

        .lang-option {
            padding: 10px 15px;
            color: #333;
            text-decoration: none;
            display: block;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .lang-option:hover {
            background-color: #f1f1f1;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .stats-section {
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            margin-top: 0;
            color: #495057;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .button-group {
            text-align: center;
            margin: 20px 0;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            /* 优化图表容器在手机上的显示 */
            height: 400px;
            position: relative;
        }

        /* 为小屏幕优化图表高度 */
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.5em;
            }
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }

        .nav-btn.active {
            background-color: #007bff;
            color: white;
        }

        /* 为小屏幕优化导航按钮 */
        @media (max-width: 768px) {
            .nav-buttons {
                gap: 5px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* 优化日期选择区域 */
        .date-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .date-selection input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .date-selection button {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2><span data-lang="inbound_statistics">入库统计数据</span></h2>

        <div class="user-info">
            <span id="usernameDisplay">用户: 未登录</span>
            <button id="logoutBtn" class="nav-btn">
                <span data-lang="logout">登出</span>
            </button>
        </div>
        <div class="language-selector">
            <div class="lang-dropdown">
                <div class="lang-selected" id="langSelected">
                    <span id="currentLangText">中文</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="lang-dropdown-content" id="langDropdown">
                    <a href="#" class="lang-option" data-lang="zh">中文</a>
                    <a href="#" class="lang-option" data-lang="en">English</a>
                    <a href="#" class="lang-option" data-lang="es">Español</a>
                </div>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="/" class="nav-btn" data-lang="inbound_entry">入库录入</a>
            <a href="/sorting" class="nav-btn" data-lang="sorting_entry">分拣录入</a>
            <a href="/statistics" class="nav-btn active" data-lang="statistics_data">统计数据</a>
            <a href="/history" class="nav-btn" data-lang="history_query">历史查询</a>
        </div>

        <!-- Date selection -->
        <div class="stats-section">
            <h3 data-lang="select_date">选择日期</h3>
            <div class="date-selection">
                <input type="date" id="selectedDate">
                <button id="loadDataBtn" data-lang="load_data">加载数据</button>
                <button id="todayBtn" data-lang="today">今天</button>
            </div>
        </div>

        <!-- Pickup forecast section -->
        <div class="stats-section">
            <h3 data-lang="pickup_forecast_title">揽收预估数据</h3>
            <div class="date-selection">
                <input type="number" id="pickupForecast" placeholder="请输入揽收预估数量" min="0">
                <button id="saveForecastBtn" data-lang="save_forecast">保存预估</button>
            </div>
            <div class="progress-container" style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span data-lang="actual_inbound">实际入库:</span>
                    <span id="actualInbound">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span data-lang="pickup_forecast">揽收预估:</span>
                    <span id="forecastValue">0</span>
                </div>
                <div class="progress-bar"
                    style="width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden;">
                    <div id="progressBar"
                        style="height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s;"></div>
                </div>
                <div style="text-align: center; margin-top: 5px;">
                    <span data-lang="completion_rate">完成率:</span>
                    <span id="completionRate">0%</span>
                </div>
            </div>
        </div>

        <!-- Forecast vs Actual Comparison Chart -->
        <div class="stats-section">
            <h3 data-lang="forecast_vs_actual_title">揽收预估与实际入库对比（历史数据）</h3>
            <div class="chart-container">
                <canvas id="forecastVsActualChart"></canvas>
            </div>
        </div>

        <!-- Statistics summary -->
        <div class="stats-section">
            <h3 data-lang="statistics_summary">统计摘要</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 data-lang="total_vehicles">总车次</h3>
                    <div class="stat-value" id="totalVehicles">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-lang="total_cargo">总货物量 (万)</h3>
                    <div class="stat-value" id="totalPieces">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-lang="total_pallets">托盘总数</h3>
                    <div class="stat-value" id="totalPallets">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-lang="vehicles_19_20">19:00-20:00到车数</h3>
                    <div class="stat-value" id="vehicles19to20">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-lang="vehicles_20_21">20:00-21:00到车数</h3>
                    <div class="stat-value" id="vehicles20to21">0</div>
                </div>
                <div class="stat-card">
                    <h3 data-lang="vehicles_after_24">超过24:00到车数</h3>
                    <div class="stat-value" id="vehiclesAfter24">0</div>
                </div>
            </div>
        </div>

        <!-- Vehicle statistics -->
        <div class="stats-section">
            <h3 data-lang="vehicle_statistics">各车型统计</h3>
            <table id="vehicleStatsTable">
                <thead>
                    <tr>
                        <th data-lang="vehicle_type">车型</th>
                        <th data-lang="vehicle_count">车次</th>
                        <th data-lang="total_cargo_amount">货物总量</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic data filling -->
                </tbody>
            </table>
        </div>

        <!-- 19:00-20:00 vehicle statistics by type -->
        <div class="stats-section">
            <h3 data-lang="vehicles_19_20_by_type">19:00-20:00各车型到车统计</h3>
            <table id="vehicleStats19to20Table">
                <thead>
                    <tr>
                        <th data-lang="vehicle_type">车型</th>
                        <th data-lang="vehicle_arrival_count">到车数量</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic data filling -->
                </tbody>
            </table>
        </div>

        <!-- 20:00-21:00 vehicle statistics by type -->
        <div class="stats-section">
            <h3 data-lang="vehicles_20_21_by_type">20:00-21:00各车型到车统计</h3>
            <table id="vehicleStats20to21Table">
                <thead>
                    <tr>
                        <th data-lang="vehicle_type">车型</th>
                        <th data-lang="vehicle_arrival_count">到车数量</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Dynamic data filling -->
                </tbody>
            </table>
        </div>

        <!-- Hourly comparison chart -->
        <div class="stats-section">
            <h3 data-lang="inbound_sorting_comparison">入库与分拣时段对比</h3>
            <div class="chart-container">
                <canvas id="hourlyComparisonChart"></canvas>
            </div>
        </div>

        <!-- Difference analysis chart -->
        <div class="stats-section">
            <h3 data-lang="difference_analysis">入库与分拣差异分析</h3>
            <div class="chart-container">
                <canvas id="differenceAnalysisChart"></canvas>
            </div>
        </div>

        <!-- Pallet hourly chart -->
        <div class="stats-section">
            <h3 data-lang="pallet_hourly_comparison">托盘时段统计</h3>
            <div class="chart-container">
                <canvas id="palletHourlyChart"></canvas>
            </div>
        </div>

        <!-- Daily Trend Chart -->
        <div class="stats-section">
            <h3 data-lang="daily_trend_chart">每日货物趋势</h3>
            <div class="chart-container">
                <canvas id="dailyTrendChart"></canvas>
            </div>
        </div>

        <!-- Week Comparison Chart -->
        <div class="stats-section">
            <h3 data-lang="week_comparison_chart">周环比对比</h3>
            <div class="chart-container" style="height: 400px;">
                <canvas id="weekComparisonChart"></canvas>
            </div>
        </div>

        <div class="button-group">
            <button id="refreshData" data-lang="refresh_data">刷新数据</button>
            <button id="exportExcel" data-lang="export_excel">导出表格</button>
        </div>

        <div id="message"></div>
    </div>

    <script>
        // Language translations
        const translations = {
            zh: {
                statistics_title: "入库统计",
                inbound_statistics: "入库统计数据",
                inbound_entry: "入库录入",
                sorting_entry: "分拣录入",
                statistics_data: "统计数据",
                history_query: "历史查询",
                select_date: "选择日期",
                load_data: "加载数据",
                today: "今天",
                statistics_summary: "统计摘要",
                total_vehicles: "总车次",
                total_cargo: "总货物量 (万)",
                total_pallets: "托盘总数",
                vehicles_19_20: "19:00-20:00到车数",
                vehicles_20_21: "20:00-21:00到车数",
                vehicles_after_24: "超过24:00到车数",
                vehicle_statistics: "各车型统计",
                vehicle_type: "车型",
                vehicle_count: "车次",
                total_cargo_amount: "货物总量",
                vehicles_19_20_by_type: "19:00-20:00各车型到车统计",
                vehicles_20_21_by_type: "20:00-21:00各车型到车统计",
                vehicle_arrival_count: "到车数量",
                inbound_sorting_comparison: "入库与分拣时段对比",
                difference_analysis: "入库与分拣差异",
                pallet_hourly_comparison: "托盘时段统计",
                refresh_data: "刷新数据",
                export_excel: "导出表格",
                no_data: "暂无数据",
                load_stats_error: "加载统计数据出错，请检查网络连接。",
                load_hourly_error: "加载时段对比数据出错:",
                load_pallet_error: "加载托盘时段数据出错:",
                export_error: "导出表格文件出错:",
                export_success: "正在导出数据，请稍候...",
                processing_error: "处理时段对比数据出错:",
                processing_pallet_error: "处理托盘时段数据出错:",
                render_error: "渲染时段对比图表出错:",
                render_pallet_error: "渲染托盘时段图表出错:",
                render_difference_error: "渲染差异分析图表出错:",
                pallet_pieces: "托盘件数",
                pallet_count: "托盘车次",
                inbound_pieces: "入库件数",
                sorting_pieces: "分拣件数",
                difference_value: "差异值",
                inbound_sorting_difference: "入库与分拣差异",
                inbound_sorting_comparison_chart_title: "入库件数与分拣件数时段对比",
                difference_analysis_chart_title: "入库与分拣差异",
                pieces: "件数",
                time_slot: "时间段",
                pickup_forecast_title: "揽收预估数据",
                save_forecast: "保存预估",
                actual_inbound: "实际入库:",
                pickup_forecast: "揽收预估:",
                completion_rate: "完成率:",
                select_date_first: "请先选择日期",
                enter_valid_forecast: "请输入有效的预估数量",
                forecast_saved: "预估数据保存成功",
                save_failed: "保存失败",
                logout: "登出",
                daily_trend_chart: "每日货物趋势",
                week_comparison_chart: "周环比对比",
                current_week: "本周",
                previous_week: "上周",
                change_percent: "环比变化",
                historical_avg: "历史日均值",
                forecast_vs_actual_title: "揽收预估与实际入库对比（历史数据）",
                forecast_value: "预估值",
                actual_value: "实际值",
                difference_percent: "差异百分比",
            },
            en: {
                statistics_title: "Inbound Statistics",
                inbound_statistics: "Inbound Statistics Data",
                inbound_entry: "Inbound Entry",
                sorting_entry: "Sorting Entry",
                statistics_data: "Statistics Data",
                history_query: "History Query",
                select_date: "Select Date",
                load_data: "Load Data",
                today: "Today",
                statistics_summary: "Statistics Summary",
                total_vehicles: "Total Vehicles",
                total_cargo: "Total Cargo (10k)",
                total_pallets: "Total Pallets",
                vehicles_19_20: "Vehicles 19:00-20:00",
                vehicles_20_21: "Vehicles 20:00-21:00",
                vehicles_after_24: "Vehicles After 24:00",
                vehicle_statistics: "Vehicle Statistics by Type",
                vehicle_type: "Vehicle Type",
                vehicle_count: "Vehicle Count",
                total_cargo_amount: "Total Cargo Amount",
                vehicles_19_20_by_type: "Vehicles 19:00-20:00 by Type",
                vehicles_20_21_by_type: "Vehicles 20:00-21:00 by Type",
                vehicle_arrival_count: "Arrival Count",
                inbound_sorting_comparison: "Inbound vs Sorting Hourly Comparison",
                difference_analysis: "Inbound vs Sorting Difference",
                pallet_hourly_comparison: "Pallet Hourly Statistics",
                refresh_data: "Refresh Data",
                export_excel: "Export Table",
                no_data: "No data",
                load_stats_error: "Error loading statistics, please check your network connection.",
                load_hourly_error: "Error loading hourly comparison data:",
                load_pallet_error: "Error loading pallet hourly data:",
                export_error: "Error exporting table file:",
                export_success: "Exporting data, please wait...",
                processing_error: "Error processing hourly comparison data:",
                processing_pallet_error: "Error processing pallet hourly data:",
                render_error: "Error rendering hourly comparison chart:",
                render_pallet_error: "Error rendering pallet hourly chart:",
                render_difference_error: "Error rendering difference analysis chart:",
                pallet_pieces: "Pallet Pieces",
                pallet_count: "Pallet Count",
                inbound_pieces: "Inbound Pieces",
                sorting_pieces: "Sorting Pieces",
                difference_value: "Difference Value",
                inbound_sorting_difference: "Inbound vs Sorting Difference",
                inbound_sorting_comparison_chart_title: "Inbound vs Sorting Pieces Hourly Comparison",
                difference_analysis_chart_title: "Inbound vs Sorting Difference Analysis",
                pieces: "Pieces",
                time_slot: "Time Slot",
                pickup_forecast_title: "Pickup Forecast",
                save_forecast: "Save Forecast",
                actual_inbound: "Actual Inbound:",
                pickup_forecast: "Pickup Forecast:",
                completion_rate: "Completion Rate:",
                select_date_first: "Please select a date first",
                enter_valid_forecast: "Please enter a valid forecast amount",
                forecast_saved: "Forecast data saved successfully",
                save_failed: "Save failed",
                logout: "Logout",
                daily_trend_chart: "Daily Cargo Trend",
                week_comparison_chart: "Week-over-Week Comparison",
                current_week: "Current Week",
                previous_week: "Previous Week",
                change_percent: "Change %",
                historical_avg: "Historical Daily Avg",
                forecast_vs_actual_title: "Forecast vs Actual Comparison (All Historical Data)",
                forecast_value: "Forecast",
                actual_value: "Actual",
                difference_percent: "Difference %",
            },
            es: {
                statistics_title: "Estadísticas de Entrada",
                inbound_statistics: "Datos Estadísticos de Entrada",
                inbound_entry: "Entrada de Datos",
                sorting_entry: "Entrada de Clasificación",
                statistics_data: "Datos Estadísticos",
                history_query: "Consulta Histórica",
                select_date: "Seleccionar Fecha",
                load_data: "Cargar Datos",
                today: "Hoy",
                statistics_summary: "Resumen Estadístico",
                total_vehicles: "Vehículos Totales",
                total_cargo: "Carga Total (10k)",
                total_pallets: "Total de Palets",
                vehicles_19_20: "Vehículos 19:00-20:00",
                vehicles_20_21: "Vehículos 20:00-21:00",
                vehicles_after_24: "Vehículos Después de 24:00",
                vehicle_statistics: "Estadísticas por Tipo de Vehículo",
                vehicle_type: "Tipo de Vehículo",
                vehicle_count: "Conteo de Vehículos",
                total_cargo_amount: "Cantidad Total de Carga",
                vehicles_19_20_by_type: "Vehículos 19:00-20:00 por Tipo",
                vehicles_20_21_by_type: "Vehículos 20:00-21:00 por Tipo",
                vehicle_arrival_count: "Conteo de Llegadas",
                inbound_sorting_comparison: "Comparación Horaria de Entrada y Clasificación",
                difference_analysis: "Diferencia entre Entrada y Clasificación",
                pallet_hourly_comparison: "Estadísticas Horarias de Palets",
                refresh_data: "Actualizar Datos",
                export_excel: "Exportar Tabla",
                no_data: "Sin datos",
                load_stats_error: "Error al cargar estadísticas, por favor verifique su conexión de red.",
                load_hourly_error: "Error al cargar datos de comparación horaria:",
                load_pallet_error: "Error al cargar datos horarios de palets:",
                export_error: "Error al exportar archivo de tabla:",
                export_success: "Exportando datos, por favor espere...",
                processing_error: "Error al procesar datos de comparación horaria:",
                processing_pallet_error: "Error al procesar datos horarios de palets:",
                render_error: "Error al renderizar gráfico de comparación horaria:",
                render_pallet_error: "Error al renderizar gráfico horario de palets:",
                render_difference_error: "Error al renderizar gráfico de análisis de diferencias:",
                pallet_pieces: "Piezas de Palet",
                pallet_count: "Conteo de Palets",
                inbound_pieces: "Piezas de Entrada",
                sorting_pieces: "Piezas de Clasificación",
                difference_value: "Valor de Diferencia",
                inbound_sorting_difference: "Diferencia entre Entrada y Clasificación",
                inbound_sorting_comparison_chart_title: "Comparación Horaria de Piezas de Entrada y Clasificación",
                difference_analysis_chart_title: "Análisis de Diferencias entre Entrada y Clasificación",
                pieces: "Piezas",
                time_slot: "Franja Horaria",
                pickup_forecast_title: "Previsión de Recogida",
                save_forecast: "Guardar Previsión",
                actual_inbound: "Entrada Real:",
                pickup_forecast: "Previsión de Recogida:",
                completion_rate: "Tasa de Finalización:",
                select_date_first: "Por favor seleccione una fecha primero",
                enter_valid_forecast: "Por favor ingrese una cantidad de previsión válida",
                forecast_saved: "Datos de previsión guardados exitosamente",
                save_failed: "Error al guardar",
                logout: "Cerrar sesión",
                daily_trend_chart: "Tendencia Diaria de Carga",
                week_comparison_chart: "Comparación Semanal",
                current_week: "Semana Actual",
                previous_week: "Semana Anterior",
                change_percent: "Cambio %",
                historical_avg: "Promedio Diario Histórico",
                forecast_vs_actual_title: "Comparación de Previsión vs Real (Todos los Datos Históricos)",
                forecast_value: "Previsión",
                actual_value: "Real",
                difference_percent: "Diferencia %",
            }
        };

        // Current language
        let currentLang = 'zh';

        // Set language
        function setLanguage(lang) {
            currentLang = lang;

            // Update selected language text
            const langTexts = {
                'zh': '中文',
                'en': 'English',
                'es': 'Español'
            };
            document.getElementById('currentLangText').textContent = langTexts[lang] || '中文';

            // Update all elements with data-lang attribute
            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update page title
            document.title = translations[lang].statistics_title || '入库统计';

            // Store language preference in localStorage
            localStorage.setItem('preferredLanguage', lang);

            // Re-render chart if it exists
            if (window.hourlyChart) {
                loadHourlyComparisonData();
            }
        }

        // Toggle language dropdown
        function toggleLanguageDropdown() {
            document.getElementById('langDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        window.onclick = function (event) {
            if (!event.target.matches('.lang-selected') && !event.target.closest('.lang-dropdown')) {
                const dropdowns = document.getElementsByClassName('lang-dropdown-content');
                for (let i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].classList.remove('show');
                }
            }
        }

        // Current selected date
        let currentDate = null;

        // Convert exact number to range display
        // For example: 1,232,342 -> "1,230,000-1,240,000"
        function convertToRange(value) {
            if (!value || value === 0) {
                return '0';
            }

            // For all numbers >= 10,000, display range in units of 万
            const roundTo = 10000;

            if (value >= roundTo) {
                // Calculate lower and upper bounds
                const lowerBound = Math.floor(value / roundTo) * roundTo;
                const upperBound = Math.ceil(value / roundTo) * roundTo;

                // Convert to 万 units
                const lowerInWan = (lowerBound / 10000).toFixed(1);
                const upperInWan = (upperBound / 10000).toFixed(1);

                return lowerInWan + '万-' + upperInWan + '万';
            } else {
                // For small numbers (< 10,000), just return the value
                return value.toLocaleString();
            }
        }

        // Check login status and update UI
        function checkLoginStatus() {
            fetch('/api/check_login')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        document.getElementById('usernameDisplay').textContent = '用户: ' + data.user.username;
                        // Update language for logout button if needed
                        if (translations[currentLang] && translations[currentLang].logout) {
                            document.querySelector('#logoutBtn span[data-lang="logout"]').textContent = translations[currentLang].logout;
                        }
                    } else {
                        document.getElementById('usernameDisplay').textContent = '用户: 未登录';
                        // Redirect to login if not logged in
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('Error checking login status:', error);
                    document.getElementById('usernameDisplay').textContent = '用户: 未登录';
                    // Redirect to login if error occurs
                    window.location.href = '/login';
                });
        }

        // Logout function
        function logout() {
            fetch('/api/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/login';
                    } else {
                        console.error('Logout failed:', data.error);
                        window.location.href = '/login';
                    }
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    window.location.href = '/login';
                });
        }

        // Load statistics data when page is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Check for saved language preference
            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang && ['zh', 'en', 'es'].includes(savedLang)) {
                setLanguage(savedLang);
            }

            // Bind language dropdown toggle
            document.getElementById('langSelected').addEventListener('click', toggleLanguageDropdown);

            // Bind language options
            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function (e) {
                    e.preventDefault();
                    const lang = this.getAttribute('data-lang');
                    setLanguage(lang);
                    document.getElementById('langDropdown').classList.remove('show');
                });
            });

            // Bind logout button
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // Check login status
            checkLoginStatus();

            // Set default date to today (using local date to avoid timezone issues)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            document.getElementById('selectedDate').value = formattedDate;
            currentDate = formattedDate;

            // Load default data
            loadData();

            // Bind date selection related events
            document.getElementById('loadDataBtn').addEventListener('click', function () {
                const selectedDate = document.getElementById('selectedDate').value;
                if (selectedDate) {
                    currentDate = selectedDate;
                    loadData();
                }
            });

            document.getElementById('todayBtn').addEventListener('click', function () {
                // Get current date in local timezone
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const todayFormatted = `${year}-${month}-${day}`;

                document.getElementById('selectedDate').value = todayFormatted;
                currentDate = todayFormatted;
                loadData();
            });

            // Bind export Excel button event
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);

            // Bind pickup forecast save button event
            setTimeout(function () {
                const saveBtn = document.getElementById('saveForecastBtn');
                if (saveBtn) {
                    console.log('Binding click event to saveForecastBtn');
                    saveBtn.addEventListener('click', savePickupForecast);
                } else {
                    console.error('saveForecastBtn not found');
                }
            }, 100);

            // Listen for window resize to re-render chart for new dimensions
            window.addEventListener('resize', function () {
                if (window.hourlyChart) {
                    // Delay re-rendering to avoid frequent calls
                    clearTimeout(window.resizeTimer);
                    window.resizeTimer = setTimeout(function () {
                        loadHourlyComparisonData();
                    }, 300);
                }
            });
        });

        // Refresh data button
        document.getElementById('refreshData').addEventListener('click', function () {
            loadData();
        });

        // Save pickup forecast data
        function savePickupForecast() {
            const forecastAmount = document.getElementById('pickupForecast').value;
            const selectedDate = currentDate || document.getElementById('selectedDate').value;

            console.log('Saving forecast data:', { date: selectedDate, amount: forecastAmount });

            if (!selectedDate) {
                showMessage(translations[currentLang].select_date_first || '请先选择日期', 'error');
                return;
            }

            if (!forecastAmount || forecastAmount < 0) {
                showMessage(translations[currentLang].enter_valid_forecast || '请输入有效的预估数量', 'error');
                return;
            }

            fetch('/api/pickup_forecast', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: selectedDate,
                    amount: parseInt(forecastAmount)
                })
            })
                .then(response => {
                    console.log('Forecast save response:', response);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Forecast save result:', data);
                    if (data.success) {
                        showMessage(translations[currentLang].forecast_saved || '预估数据保存成功', 'success');
                        // 重新加载数据以更新进度条
                        setTimeout(function () {
                            loadData();
                        }, 500);
                    } else {
                        showMessage(translations[currentLang].save_failed || '保存失败: ' + (data.error || '未知错误'), 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving forecast:', error);
                    showMessage(translations[currentLang].save_failed || '保存失败: ' + error.message, 'error');
                });
        }

        // Update progress bar based on actual inbound and forecast
        function updateProgressBar(actualInbound, forecastAmount) {
            const actualElement = document.getElementById('actualInbound');
            const forecastElement = document.getElementById('forecastValue');
            const progressBar = document.getElementById('progressBar');
            const completionRateElement = document.getElementById('completionRate');

            // Update displayed values
            actualElement.textContent = actualInbound.toLocaleString();
            forecastElement.textContent = forecastAmount.toLocaleString();

            // Calculate completion rate
            let completionRate = 0;
            if (forecastAmount > 0) {
                completionRate = Math.round((actualInbound / forecastAmount) * 100);
            }

            // Update progress bar width (max 100%)
            const progressWidth = Math.min(completionRate, 100);
            progressBar.style.width = progressWidth + '%';

            // Change color based on completion rate
            if (completionRate >= 100) {
                progressBar.style.backgroundColor = '#4CAF50'; // Green
            } else if (completionRate >= 80) {
                progressBar.style.backgroundColor = '#FF9800'; // Orange
            } else {
                progressBar.style.backgroundColor = '#f44336'; // Red
            }

            // Update completion rate text
            completionRateElement.textContent = completionRate + '%';
        }

        // Load statistics data
        function loadData() {
            console.log('Loading data for date:', currentDate);
            // Get statistics data
            let url = '/api/stats';
            if (currentDate) {
                url += '?date=' + encodeURIComponent(currentDate);
            }

            // Variable to store stats data for use in other parts of the function
            let loadedStatsData = null;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Loaded stats data:', data);
                    // Store data in a variable accessible to other functions
                    loadedStatsData = data;
                    // Update summary statistics
                    document.getElementById('totalVehicles').textContent = data.total_vehicles || 0;
                    // Display total pieces as a range instead of exact number
                    document.getElementById('totalPieces').textContent = convertToRange(data.total_pieces || 0);
                    document.getElementById('totalPallets').textContent = data.total_pallets || 0;
                    document.getElementById('vehicles19to20').textContent = data.vehicles_19_to_20 || 0;
                    document.getElementById('vehicles20to21').textContent = data.vehicles_20_to_21 || 0;
                    document.getElementById('vehiclesAfter24').textContent = data.vehicles_after_24 || 0;

                    // Update vehicle statistics table
                    const vehicleStatsBody = document.querySelector('#vehicleStatsTable tbody');
                    vehicleStatsBody.innerHTML = '';
                    if (data.vehicle_stats) {
                        data.vehicle_stats.forEach(stat => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                            <td>${stat.vehicle_type}</td>
                            <td>${stat.count}</td>
                            <td>${stat.total_pieces}</td>
                        `;
                            vehicleStatsBody.appendChild(row);
                        });
                    }

                    // Update 19:00-20:00 vehicle statistics by type table
                    const vehicleStats19to20Body = document.querySelector('#vehicleStats19to20Table tbody');
                    vehicleStats19to20Body.innerHTML = '';
                    if (data.vehicles_19_to_20_by_type) {
                        Object.entries(data.vehicles_19_to_20_by_type).forEach(([vehicleType, count]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                            <td>${vehicleType}</td>
                            <td>${count}</td>
                        `;
                            vehicleStats19to20Body.appendChild(row);
                        });

                        // If no data, show prompt message
                        if (Object.keys(data.vehicles_19_to_20_by_type).length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="2" style="text-align: center; color: #666;">${translations[currentLang].no_data || '暂无数据'}</td>`;
                            vehicleStats19to20Body.appendChild(row);
                        }
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="2" style="text-align: center; color: #666;">${translations[currentLang].no_data || '暂无数据'}</td>`;
                        vehicleStats19to20Body.appendChild(row);
                    }

                    // Update 20:00-21:00 vehicle statistics by type table
                    const vehicleStats20to21Body = document.querySelector('#vehicleStats20to21Table tbody');
                    vehicleStats20to21Body.innerHTML = '';
                    if (data.vehicles_20_to_21_by_type) {
                        Object.entries(data.vehicles_20_to_21_by_type).forEach(([vehicleType, count]) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                            <td>${vehicleType}</td>
                            <td>${count}</td>
                        `;
                            vehicleStats20to21Body.appendChild(row);
                        });

                        // If no data, show prompt message
                        if (Object.keys(data.vehicles_20_to_21_by_type).length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `<td colspan="2" style="text-align: center; color: #666;">${translations[currentLang].no_data || '暂无数据'}</td>`;
                            vehicleStats20to21Body.appendChild(row);
                        }
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="2" style="text-align: center; color: #666;">${translations[currentLang].no_data || '暂无数据'}</td>`;
                        vehicleStats20to21Body.appendChild(row);
                    }

                    // Return data for use in the next then block
                    return data;
                })
                .then(statsData => {
                    // Get pickup forecast data and update progress bar
                    let forecastUrl = '/api/pickup_forecast';
                    if (currentDate) {
                        forecastUrl += '?date=' + encodeURIComponent(currentDate);
                    }

                    console.log('Loading forecast data with URL:', forecastUrl);
                    return fetch(forecastUrl)
                        .then(response => response.json())
                        .then(forecastData => {
                            console.log('Loaded forecast data:', forecastData);
                            // Get actual inbound amount from stats data
                            const actualInbound = (statsData && statsData.total_pieces) ? statsData.total_pieces : 0;
                            const forecastAmount = (forecastData && forecastData.amount) ? forecastData.amount : 0;

                            // Update progress bar
                            updateProgressBar(actualInbound, forecastAmount);

                            // Update forecast input field
                            document.getElementById('pickupForecast').value = forecastAmount;

                            // Get hourly comparison data
                            loadHourlyComparisonData();
                        })
                        .catch(error => {
                            console.error('Error loading forecast data:', error);
                            // Even if forecast data loading fails, still update progress bar with 0 values
                            const actualInbound = (statsData && statsData.total_pieces) ? statsData.total_pieces : 0;
                            updateProgressBar(actualInbound, 0);

                            // Get hourly comparison data
                            loadHourlyComparisonData();
                        });
                })
                .finally(() => {
                    // Load pallet hourly data
                    loadPalletHourlyData();
                });
        }

        // Load hourly comparison data
        function loadHourlyComparisonData() {
            // Get inbound and sorting data grouped by hour
            let inboundUrl = '/api/inbound_hourly';
            let sortingUrl = '/api/sorting_hourly';
            if (currentDate) {
                inboundUrl += '?date=' + encodeURIComponent(currentDate);
                sortingUrl += '?date=' + encodeURIComponent(currentDate);
            }

            Promise.all([
                fetch(inboundUrl).then(response => {
                    if (!response.ok) {
                        throw new Error('Inbound data loading failed: ' + response.status);
                    }
                    return response.json();
                }),
                fetch(sortingUrl).then(response => {
                    if (!response.ok) {
                        throw new Error('Sorting data loading failed: ' + response.status);
                    }
                    return response.json();
                })
            ])
                .then(([inboundData, sortingData]) => {
                    // Process data and generate chart
                    const hourlyData = processHourlyDataByTimeSlot(inboundData, sortingData);
                    renderHourlyComparisonChart(hourlyData);

                    // Process data for difference analysis chart
                    const differenceData = processDifferenceData(inboundData, sortingData);
                    renderDifferenceAnalysisChart(differenceData);
                })
                .catch(error => {
                    console.error('Error loading hourly data:', error);
                    showMessage(translations[currentLang].load_hourly_error || '加载时段对比数据出错: ' + error.message, 'error');
                });

            // Load pallet hourly data
            loadPalletHourlyData();
        }

        // Load pallet hourly data
        function loadPalletHourlyData() {
            let palletUrl = '/api/pallet_hourly';
            if (currentDate) {
                palletUrl += '?date=' + encodeURIComponent(currentDate);
            }

            fetch(palletUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Pallet data loading failed: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    renderPalletHourlyChart(data);
                })
                .catch(error => {
                    console.error('Error loading pallet data:', error);
                    showMessage(translations[currentLang].load_pallet_error || '加载托盘时段数据出错: ' + error.message, 'error');
                });
        }

        // Process data grouped by time slot
        function processHourlyDataByTimeSlot(inboundData, sortingData) {
            try {
                // Create a map to store data for each time slot
                const timeSlotMap = {};

                // Process inbound data
                if (Array.isArray(inboundData)) {
                    inboundData.forEach(record => {
                        if (record && typeof record === 'object') {
                            const timeSlot = record.time_slot || translations[currentLang].unknown || '未知';
                            if (!timeSlotMap[timeSlot]) {
                                timeSlotMap[timeSlot] = {
                                    timeSlot: timeSlot,
                                    inboundPieces: 0,  // 入库件数
                                    sortingPieces: 0
                                };
                            }
                            // 累加入库件数
                            if (record.total_pieces !== undefined) {
                                timeSlotMap[timeSlot].inboundPieces += (parseInt(record.total_pieces) || 0);
                            }
                        }
                    });
                }

                // Process sorting data
                if (Array.isArray(sortingData)) {
                    sortingData.forEach(record => {
                        if (record && typeof record === 'object') {
                            const timeSlot = record.time_slot || translations[currentLang].unknown || '未知';
                            if (!timeSlotMap[timeSlot]) {
                                timeSlotMap[timeSlot] = {
                                    timeSlot: timeSlot,
                                    inboundPieces: 0,  // 入库件数
                                    sortingPieces: 0
                                };
                            }
                            timeSlotMap[timeSlot].sortingPieces += (parseInt(record.total_pieces) || 0);
                        }
                    });
                }

                // Convert to array and sort
                const result = Object.values(timeSlotMap).sort((a, b) => {
                    // Numeric sorting to ensure time slots are in correct order
                    const aSlot = a.timeSlot === (translations[currentLang].unknown || '未知') ? -1 : parseInt(a.timeSlot);
                    const bSlot = b.timeSlot === (translations[currentLang].unknown || '未知') ? -1 : parseInt(b.timeSlot);

                    // Handle NaN cases
                    if (isNaN(aSlot) && isNaN(bSlot)) return 0;
                    if (isNaN(aSlot)) return 1;
                    if (isNaN(bSlot)) return -1;

                    return aSlot - bSlot;
                });

                console.log('Processed hourly data:', result);
                return result;
            } catch (error) {
                console.error('Error processing hourly data:', error);
                showMessage(translations[currentLang].processing_error || '处理时段对比数据出错: ' + error.message, 'error');
                return [];
            }
        }

        // Process data for difference analysis
        function processDifferenceData(inboundData, sortingData) {
            try {
                // Create a map to store data for each time slot
                const timeSlotMap = {};

                // Process inbound data
                if (Array.isArray(inboundData)) {
                    inboundData.forEach(record => {
                        if (record && typeof record === 'object') {
                            const timeSlot = record.time_slot || translations[currentLang].unknown || '未知';
                            if (!timeSlotMap[timeSlot]) {
                                timeSlotMap[timeSlot] = {
                                    timeSlot: timeSlot,
                                    inboundPieces: 0,
                                    sortingPieces: 0
                                };
                            }
                            // 累加入库件数
                            if (record.total_pieces !== undefined) {
                                timeSlotMap[timeSlot].inboundPieces += (parseInt(record.total_pieces) || 0);
                            }
                        }
                    });
                }

                // Process sorting data
                if (Array.isArray(sortingData)) {
                    sortingData.forEach(record => {
                        if (record && typeof record === 'object') {
                            const timeSlot = record.time_slot || translations[currentLang].unknown || '未知';
                            if (!timeSlotMap[timeSlot]) {
                                timeSlotMap[timeSlot] = {
                                    timeSlot: timeSlot,
                                    inboundPieces: 0,
                                    sortingPieces: 0
                                };
                            }
                            // 累加分拣件数
                            if (record.total_pieces !== undefined) {
                                timeSlotMap[timeSlot].sortingPieces += (parseInt(record.total_pieces) || 0);
                            }
                        }
                    });
                }

                // Calculate differences and convert to array
                const result = Object.values(timeSlotMap).map(item => {
                    return {
                        timeSlot: item.timeSlot,
                        inboundPieces: item.inboundPieces,
                        sortingPieces: item.sortingPieces,
                        difference: item.inboundPieces - item.sortingPieces
                    };
                }).sort((a, b) => {
                    // Numeric sorting to ensure time slots are in correct order
                    const aSlot = a.timeSlot === (translations[currentLang].unknown || '未知') ? -1 : parseInt(a.timeSlot);
                    const bSlot = b.timeSlot === (translations[currentLang].unknown || '未知') ? -1 : parseInt(b.timeSlot);

                    // Handle NaN cases
                    if (isNaN(aSlot) && isNaN(bSlot)) return 0;
                    if (isNaN(aSlot)) return 1;
                    if (isNaN(bSlot)) return -1;

                    return aSlot - bSlot;
                });

                console.log('Processed difference data:', result);
                return result;
            } catch (error) {
                console.error('Error processing difference data:', error);
                showMessage(translations[currentLang].processing_error || '处理差异分析数据出错: ' + error.message, 'error');
                return [];
            }
        }

        // Render hourly comparison chart
        function renderHourlyComparisonChart(data) {
            try {
                const ctx = document.getElementById('hourlyComparisonChart').getContext('2d');

                // Destroy existing chart instance
                if (window.hourlyChart) {
                    window.hourlyChart.destroy();
                }

                // Check if there is data
                if (!data || data.length === 0) {
                    // If no data, show prompt message
                    document.getElementById('hourlyComparisonChart').innerHTML = `<p style="text-align: center; color: #666; padding: 20px;">${translations[currentLang].no_data || '暂无时段对比数据'}</p>`;
                    return;
                }

                // Calculate max value for setting y-axis range
                const maxInbound = Math.max(...data.map(item => item.inboundPieces));
                const maxSorting = Math.max(...data.map(item => item.sortingPieces));
                const maxValue = Math.max(maxInbound, maxSorting);

                // Calculate appropriate y-axis max value and step size
                const yAxisMax = Math.ceil(maxValue / 1000) * 1000;
                const stepSize = Math.ceil(yAxisMax / 5 / 1000) * 1000;

                // Detect if it's a mobile device
                const isMobile = window.innerWidth < 768;

                window.hourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.timeSlot),
                        datasets: [
                            {
                                label: translations[currentLang].inbound_pieces || '入库件数',
                                data: data.map(item => item.inboundPieces),
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                // Add data labels
                                datalabels: {
                                    anchor: 'end',
                                    align: isMobile ? 'top' : 'top',
                                    offset: isMobile ? -10 : -20,
                                    formatter: function (value) {
                                        // On mobile devices, don't show labels if value is small to avoid overlap
                                        if (isMobile && value < maxValue * 0.1) {
                                            return '';
                                        }
                                        return value > 0 ? value.toLocaleString() : '';
                                    },
                                    font: {
                                        weight: 'bold',
                                        size: isMobile ? 10 : 12
                                    },
                                    color: '#333'
                                }
                            },
                            {
                                label: translations[currentLang].sorting_pieces || '分拣件数',
                                data: data.map(item => item.sortingPieces),
                                backgroundColor: 'rgba(255, 99, 132, 0.6)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1,
                                // Add data labels
                                datalabels: {
                                    anchor: 'end',
                                    align: isMobile ? 'top' : 'top',
                                    offset: isMobile ? -20 : -35,
                                    formatter: function (value) {
                                        // On mobile devices, don't show labels if value is small to avoid overlap
                                        if (isMobile && value < maxValue * 0.1) {
                                            return '';
                                        }
                                        return value > 0 ? value.toLocaleString() : '';
                                    },
                                    font: {
                                        weight: 'bold',
                                        size: isMobile ? 10 : 12
                                    },
                                    color: '#333'
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: isMobile ? 'top' : 'top',
                                labels: {
                                    // Reduce legend font on mobile
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Increase legend spacing on mobile devices
                                    padding: isMobile ? 10 : 15
                                }
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].inbound_sorting_comparison_chart_title || '入库件数与分拣件数时段对比',
                                font: {
                                    size: isMobile ? 14 : 16
                                }
                            },
                            // Add data labels plugin configuration
                            datalabels: {
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 10 : 12
                                },
                                formatter: function (value) {
                                    // Don't show label if value is 0
                                    return value > 0 ? value.toLocaleString() : '';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                // Set appropriate y-axis range and scale
                                min: 0,
                                max: yAxisMax > 0 ? yAxisMax : undefined,
                                ticks: {
                                    // Improve y-axis scale display
                                    stepSize: stepSize > 0 ? stepSize : undefined,
                                    callback: function (value) {
                                        // Format y-axis labels, add thousand separators
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(1) + 'K';
                                        }
                                        return value;
                                    },
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Reduce y-axis label count on mobile devices to avoid crowding
                                    maxTicksLimit: isMobile ? 5 : 10
                                },
                                title: {
                                    display: true,
                                    text: translations[currentLang].pieces || '数量',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].time_slot || '时间段',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Rotate labels on mobile devices to avoid overlap
                                    autoSkip: isMobile,
                                    maxRotation: isMobile ? 45 : 0,
                                    minRotation: isMobile ? 45 : 0
                                }
                            }
                        },
                        // Improve mobile interaction
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        // Add animation effects
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        // Adjust layout on mobile devices
                        layout: {
                            padding: {
                                top: isMobile ? 30 : 50,
                                right: isMobile ? 10 : 20,
                                bottom: isMobile ? 10 : 20,
                                left: isMobile ? 10 : 20
                            }
                        }
                    },
                    // Register data labels plugin
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error rendering chart:', error);
                showMessage(translations[currentLang].render_error || '渲染时段对比图表出错: ' + error.message, 'error');
            }
        }

        // Render difference analysis chart
        function renderDifferenceAnalysisChart(data) {
            try {
                const ctx = document.getElementById('differenceAnalysisChart').getContext('2d');

                // Destroy existing chart instance
                if (window.differenceChart) {
                    window.differenceChart.destroy();
                }

                // Check if there is data
                if (!data || data.length === 0) {
                    // If no data, show prompt message
                    document.getElementById('differenceAnalysisChart').innerHTML = `<p style="text-align: center; color: #666; padding: 20px;">${translations[currentLang].no_data || '暂无差异分析数据'}</p>`;
                    return;
                }

                // Calculate max values for setting y-axis range
                const maxInbound = Math.max(...data.map(item => item.inboundPieces));
                const maxSorting = Math.max(...data.map(item => item.sortingPieces));
                const maxDifference = Math.max(...data.map(item => Math.abs(item.difference)));
                const maxValue = Math.max(maxInbound, maxSorting, maxDifference);

                // Calculate appropriate y-axis max value and step size
                const yAxisMax = Math.ceil(maxValue / 100) * 100;
                const stepSize = Math.ceil(yAxisMax / 5 / 100) * 100;

                // Detect if it's a mobile device
                const isMobile = window.innerWidth < 768;

                window.differenceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(item => item.timeSlot),
                        datasets: [
                            {
                                label: translations[currentLang].difference_value || '差异值',
                                data: data.map(item => item.difference),
                                backgroundColor: item => {
                                    // Color bars based on positive/negative difference
                                    const difference = item.difference;
                                    return difference >= 0 ? 'rgba(54, 162, 235, 0.6)' : 'rgba(255, 206, 86, 0.6)';
                                },
                                borderColor: item => {
                                    // Border color based on positive/negative difference
                                    const difference = item.difference;
                                    return difference >= 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 206, 86, 1)';
                                },
                                borderWidth: 1,
                                // Add data labels
                                datalabels: {
                                    anchor: 'end',
                                    align: isMobile ? 'top' : 'top',
                                    offset: isMobile ? -10 : -20,
                                    formatter: function (value) {
                                        // On mobile devices, don't show labels if value is small to avoid overlap
                                        if (isMobile && Math.abs(value) < maxValue * 0.1) {
                                            return '';
                                        }
                                        return value !== 0 ? value.toLocaleString() : '';
                                    },
                                    font: {
                                        weight: 'bold',
                                        size: isMobile ? 10 : 12
                                    },
                                    color: '#333'
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: isMobile ? 'top' : 'top',
                                labels: {
                                    // Reduce legend font on mobile
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Increase legend spacing on mobile devices
                                    padding: isMobile ? 10 : 15
                                }
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].difference_analysis_chart_title || '入库与分拣差异分析',
                                font: {
                                    size: isMobile ? 14 : 16
                                }
                            },
                            // Add data labels plugin configuration
                            datalabels: {
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 10 : 12
                                },
                                formatter: function (value) {
                                    // Don't show label if value is 0
                                    return value !== 0 ? value.toLocaleString() : '';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                // Set appropriate y-axis range and scale
                                min: -yAxisMax,
                                max: yAxisMax,
                                ticks: {
                                    // Improve y-axis scale display
                                    stepSize: stepSize,
                                    callback: function (value) {
                                        // Format y-axis labels, add thousand separators
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(1) + 'K';
                                        }
                                        return value;
                                    },
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Reduce y-axis label count on mobile devices to avoid crowding
                                    maxTicksLimit: isMobile ? 5 : 10
                                },
                                title: {
                                    display: true,
                                    text: translations[currentLang].pieces || '件数',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].time_slot || '时间段',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Rotate labels on mobile devices to avoid overlap
                                    autoSkip: isMobile,
                                    maxRotation: isMobile ? 45 : 0,
                                    minRotation: isMobile ? 45 : 0
                                }
                            }
                        },
                        // Improve mobile interaction
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        // Add animation effects
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        // Adjust layout on mobile devices
                        layout: {
                            padding: {
                                top: isMobile ? 30 : 50,
                                right: isMobile ? 10 : 20,
                                bottom: isMobile ? 10 : 20,
                                left: isMobile ? 10 : 20
                            }
                        }
                    },
                    // Register data labels plugin
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error rendering difference chart:', error);
                showMessage(translations[currentLang].render_difference_error || '渲染差异分析图表出错: ' + error.message, 'error');

                // Show error message on canvas
                try {
                    const canvas = document.getElementById('differenceAnalysisChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#f72585';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('图表渲染出错: ' + error.message, canvas.width / 2, canvas.height / 2);
                    }
                } catch (canvasError) {
                    console.error('Error displaying error on canvas:', canvasError);
                }
            }
        }

        // Render pallet hourly chart
        function renderPalletHourlyChart(data) {
            try {
                const ctx = document.getElementById('palletHourlyChart').getContext('2d');

                // Destroy existing chart instance
                if (window.palletHourlyChart && typeof window.palletHourlyChart.destroy === 'function') {
                    window.palletHourlyChart.destroy();
                } else if (window.palletHourlyChart) {
                    // If it's not a chart instance, delete the property
                    delete window.palletHourlyChart;
                }

                // 处理新的数据结构
                const currentDay = data.current_day || [];
                const historicalAvg = data.historical_avg || [];

                // Check if there is data
                if (!currentDay || currentDay.length === 0) {
                    // If no data, show prompt message on canvas
                    const canvas = document.getElementById('palletHourlyChart');
                    const ctx = canvas.getContext('2d');

                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // Draw text on canvas
                    ctx.fillStyle = '#666';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(translations[currentLang].no_data || '暂无时段对比数据', canvas.width / 2, canvas.height / 2);
                    return;
                }

                // 获取所有时段标签（合并当天和历史数据的时段）
                const allTimeSlots = new Set();
                currentDay.forEach(item => allTimeSlots.add(item.time_slot));
                historicalAvg.forEach(item => allTimeSlots.add(item.time_slot));
                const timeSlots = Array.from(allTimeSlots).sort((a, b) => {
                    // 数字排序
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    return numA - numB;
                });

                // 创建时段到数据的映射
                const currentDayMap = {};
                currentDay.forEach(item => {
                    currentDayMap[item.time_slot] = item.total_load_amount;
                });

                const historicalAvgMap = {};
                historicalAvg.forEach(item => {
                    historicalAvgMap[item.time_slot] = item.avg_load_amount;
                });

                // 为每个时段填充数据
                // 使用null代替0，让Chart.js跳过无数据的点
                const currentDayData = timeSlots.map(slot =>
                    currentDayMap.hasOwnProperty(slot) ? currentDayMap[slot] : null
                );
                const historicalAvgData = timeSlots.map(slot =>
                    historicalAvgMap.hasOwnProperty(slot) ? historicalAvgMap[slot] : null
                );

                // Calculate max values for setting y-axis range
                const maxLoadAmount = Math.max(...currentDayData.filter(v => v !== null), ...historicalAvgData.filter(v => v !== null));

                // Calculate appropriate y-axis max value and step size
                const loadAmountYAxisMax = Math.ceil(maxLoadAmount / 500) * 500;
                const loadAmountStepSize = Math.ceil(loadAmountYAxisMax / 5 / 500) * 500;

                // Detect if it's a mobile device
                const isMobile = window.innerWidth < 768;

                window.palletHourlyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: timeSlots,
                        datasets: [
                            {
                                label: translations[currentLang].pallet_pieces || '当天装载量',
                                type: 'bar',
                                data: currentDayData,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                order: 2,
                                // Add data labels
                                datalabels: {
                                    anchor: 'end',
                                    align: isMobile ? 'top' : 'top',
                                    offset: isMobile ? -10 : -20,
                                    formatter: function (value) {
                                        // On mobile devices, don't show labels if value is small to avoid overlap
                                        if (isMobile && value < maxLoadAmount * 0.1) {
                                            return '';
                                        }
                                        return value > 0 ? value.toLocaleString() : '';
                                    },
                                    font: {
                                        weight: 'bold',
                                        size: isMobile ? 10 : 12
                                    },
                                    color: '#333'
                                }
                            },
                            {
                                label: translations[currentLang].historical_avg || '历史日均值',
                                type: 'line',
                                data: historicalAvgData,
                                borderColor: '#ff6384',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 4,
                                pointBackgroundColor: '#ff6384',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointHoverRadius: 6,
                                order: 1,
                                tension: 0.4,
                                spanGaps: false,  // 不连接断点
                                // 不显示折线的数据标签
                                datalabels: {
                                    display: false
                                }
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: isMobile ? 'top' : 'top',
                                labels: {
                                    // Reduce legend font on mobile
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Increase legend spacing on mobile devices
                                    padding: isMobile ? 10 : 15
                                }
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].pallet_hourly_comparison || '26英尺和53英尺车辆装载量时段统计',
                                font: {
                                    size: isMobile ? 14 : 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += Math.round(context.parsed.y).toLocaleString();
                                        }
                                        return label;
                                    }
                                }
                            },
                            // Add data labels plugin configuration
                            datalabels: {
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 10 : 12
                                },
                                formatter: function (value) {
                                    // Don't show label if value is 0
                                    return value > 0 ? value.toLocaleString() : '';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                // 让Chart.js自动调整Y轴范围
                                // 不设置固定的max和stepSize，根据数据自动缩放
                                ticks: {
                                    callback: function (value) {
                                        // Format y-axis labels, add thousand separators
                                        if (value >= 1000000) {
                                            return (value / 1000000).toFixed(1) + 'M';
                                        } else if (value >= 1000) {
                                            return (value / 1000).toFixed(1) + 'K';
                                        }
                                        return value;
                                    },
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // 减少Y轴标签数量以避免拥挤
                                    maxTicksLimit: isMobile ? 6 : 8
                                },
                                title: {
                                    display: true,
                                    text: translations[currentLang].pallet_pieces || '装载量',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: translations[currentLang].time_slot || '时间段',
                                    font: {
                                        size: isMobile ? 12 : 14
                                    }
                                },
                                ticks: {
                                    font: {
                                        size: isMobile ? 10 : 12
                                    },
                                    // Rotate labels on mobile devices to avoid overlap
                                    autoSkip: isMobile,
                                    maxRotation: isMobile ? 45 : 0,
                                    minRotation: isMobile ? 45 : 0
                                }
                            }
                        },
                        // Improve mobile interaction
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        // Add animation effects
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        // Adjust layout on mobile devices
                        layout: {
                            padding: {
                                top: isMobile ? 30 : 50,
                                right: isMobile ? 10 : 20,
                                bottom: isMobile ? 10 : 20,
                                left: isMobile ? 10 : 20
                            }
                        }
                    },
                    // Register data labels plugin
                    plugins: [ChartDataLabels]
                });
            } catch (error) {
                console.error('Error rendering pallet chart:', error);
                showMessage(translations[currentLang].render_pallet_error || '渲染托盘时段图表出错: ' + error.message, 'error');

                // 在canvas上显示错误信息
                try {
                    const canvas = document.getElementById('palletHourlyChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#f72585';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('图表渲染出错: ' + error.message, canvas.width / 2, canvas.height / 2);
                    }
                } catch (canvasError) {
                    console.error('Error displaying error on canvas:', canvasError);
                }
            }
        }

        // Export to CSV function
        function exportToExcel() {
            try {
                // Use currently selected date as export date
                let dateStr = currentDate;

                // If no date selected, use today
                if (!dateStr) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    dateStr = `${year}-${month}-${day}`;
                }

                // Build export URL
                let exportUrl = '/api/export_csv';
                if (dateStr) {
                    exportUrl += `?date=${encodeURIComponent(dateStr)}`;
                }

                // Create temporary link and trigger download
                const link = document.createElement('a');
                link.href = exportUrl;
                link.download = `inbound_stats_${dateStr || 'today'}.csv`;  // Use English filename to avoid encoding issues
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(translations[currentLang].export_success || '正在导出数据，请稍候...', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showMessage(translations[currentLang].export_error || '导出表格文件出错: ' + error.message, 'error');
            }
        }

        // Load daily trend chart data
        function loadDailyTrendData() {
            fetch('/api/daily_trend')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading daily trend data:', data.error);
                        return;
                    }
                    renderDailyTrendChart(data);
                })
                .catch(error => {
                    console.error('Error fetching daily trend data:', error);
                });
        }

        // Render daily trend chart
        function renderDailyTrendChart(data) {
            const ctx = document.getElementById('dailyTrendChart').getContext('2d');

            // Destroy existing chart if it exists
            if (window.dailyTrendChart && typeof window.dailyTrendChart.destroy === 'function') {
                window.dailyTrendChart.destroy();
            }

            // 星期几翻译
            const weekdayTranslations = {
                'zh': ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
                'en': ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                'es': ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']
            };

            // 生成X轴标签（包含日期、星期、假期）
            const labels = data.map(item => {
                const date = new Date(item.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

                // 星期几
                const weekday = weekdayTranslations[currentLang][item.weekday_num];

                // 假期标注
                let holiday = '';
                if (item.is_holiday) {
                    holiday = currentLang === 'zh' ? ` 🎉${item.holiday_name}` :
                        currentLang === 'en' ? ` 🎉${item.holiday_name}` :
                            ` 🎉${item.holiday_name}`;
                }

                // 返回多行标签：[日期, 星期+假期]
                return [dateStr, weekday + holiday];
            });

            const pieces = data.map(item => item.total_pieces);
            const vehicles = data.map(item => item.total_vehicles);
            const pallets = data.map(item => item.total_pallets);

            window.dailyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: translations[currentLang].total_cargo || '货物总量',
                            data: pieces,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#4361ee',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: translations[currentLang].total_vehicles || '车次总数',
                            data: vehicles,
                            borderColor: '#f72585',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#f72585',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6,
                            yAxisID: 'y1'
                        },
                        {
                            label: translations[currentLang].total_pallets || '托盘总数',
                            data: pallets,
                            borderColor: '#4cc9f0',
                            backgroundColor: 'rgba(76, 201, 240, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#4cc9f0',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 6,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    // 显示完整日期和假期信息
                                    const index = context[0].dataIndex;
                                    const item = data[index];
                                    const date = new Date(item.date);
                                    const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                                    const weekday = weekdayTranslations[currentLang][item.weekday_num];
                                    const holiday = item.is_holiday ? ` (${item.holiday_name})` : '';
                                    return `${dateStr} ${weekday}${holiday}`;
                                },
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                        // 根据数据集添加单位
                                        if (context.datasetIndex === 0) {
                                            label += ' 件';
                                        } else if (context.datasetIndex === 1) {
                                            label += ' 车次';
                                        } else if (context.datasetIndex === 2) {
                                            label += ' 托盘';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                // 自动调整标签显示
                                autoSkip: true,
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: translations[currentLang].total_cargo || '货物总量 (件)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: (translations[currentLang].total_vehicles || '车次') + ' / ' + (translations[currentLang].total_pallets || '托盘')
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Load week comparison chart data
        function loadWeekComparisonData() {
            fetch('/api/week_comparison')
                .then(response => response.json())
                .then(data => {
                    // Check if it's an error object (not an array)
                    if (data && !Array.isArray(data) && data.error) {
                        console.error('Error loading week comparison data:', data.error);
                        return;
                    }
                    renderWeekComparisonChart(data);
                })
                .catch(error => {
                    console.error('Error fetching week comparison data:', error);
                    // Show error on chart area
                    try {
                        const canvas = document.getElementById('weekComparisonChart');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.font = '16px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillStyle = '#dc3545'; // Bootstrap danger color
                            ctx.fillText(translations[currentLang].error_loading_data || '加载数据出错', canvas.width / 2, canvas.height / 2);
                        }
                    } catch (e) {
                        console.error('Error displaying error message on canvas:', e);
                    }
                });
        }

        // Render week comparison chart
        function renderWeekComparisonChart(data) {
            const ctx = document.getElementById('weekComparisonChart').getContext('2d');

            // Destroy existing chart if it exists
            if (window.weekComparisonChart && typeof window.weekComparisonChart.destroy === 'function') {
                window.weekComparisonChart.destroy();
            }

            if (!data || data.length === 0) {
                const canvas = document.getElementById('weekComparisonChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#6c757d'; // Bootstrap secondary color
                ctx.fillText(translations[currentLang].no_data || '暂无数据', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Generate labels and data
            const labels = data.map(week => {
                // Formatting date range: "MM/DD - MM/DD"
                const startDate = new Date(week.start_date);
                const endDate = new Date(week.end_date);
                const startStr = `${startDate.getMonth() + 1}/${startDate.getDate()}`;
                const endStr = `${endDate.getMonth() + 1}/${endDate.getDate()}`;
                return `${startStr}-${endStr}`;
            });

            // Store original pieces data for tooltip
            const piecesDataOriginal = data.map(week => week.total_pieces);
            // Convert pieces data to units of 10,000 (万) for display
            const piecesData = data.map(week => week.total_pieces / 10000);
            const vehiclesData = data.map(week => week.vehicle_count);

            // Detect if it's a mobile device
            const isMobile = window.innerWidth < 768;

            window.weekComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: (translations[currentLang].total_cargo || '货物总量') + ' (万)',
                            data: piecesData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y',
                            // Add data labels configuration
                            datalabels: {
                                anchor: 'center',
                                align: 'center',
                                formatter: function (value, context) {
                                    // Display value in 万 with 1 decimal place
                                    return value > 0 ? value.toFixed(1) + '万' : '';
                                },
                                font: {
                                    weight: 'bold',
                                    size: isMobile ? 11 : 13
                                },
                                color: '#fff'
                            }
                        },
                        {
                            label: translations[currentLang].vehicle_count || '车次',
                            type: 'line', // Mix line chart for vehicles
                            data: vehiclesData,
                            borderColor: '#FF6384',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1',
                            // Don't show data labels for line chart
                            datalabels: {
                                display: false
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: translations[currentLang].week_comparison_chart || '周环比对比',
                            font: {
                                size: isMobile ? 14 : 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.datasetIndex === 0) {
                                            // For cargo, show both original value and value in 万
                                            const originalValue = piecesDataOriginal[context.dataIndex];
                                            const valueInWan = context.parsed.y.toFixed(1);
                                            label += `${originalValue.toLocaleString()} (${valueInWan}万)`;
                                        } else {
                                            // For vehicles, show as is
                                            label += context.parsed.y.toLocaleString();
                                        }
                                    }
                                    return label;
                                },
                                afterLabel: function (context) {
                                    // Show change percentage in tooltip
                                    const index = context.dataIndex;
                                    const weekData = data[index];
                                    if (context.datasetIndex === 0 && weekData.pieces_change_percent !== undefined) { // pieces
                                        const sign = weekData.pieces_change_percent >= 0 ? '+' : '';
                                        return `${translations[currentLang].change_percent || '环比变化'}: ${sign}${weekData.pieces_change_percent}%`;
                                    } else if (context.datasetIndex === 1 && weekData.vehicles_change_percent !== undefined) { // vehicles
                                        const sign = weekData.vehicles_change_percent >= 0 ? '+' : '';
                                        return `${translations[currentLang].change_percent || '环比变化'}: ${sign}${weekData.vehicles_change_percent}%`;
                                    }
                                    return '';
                                }
                            }
                        },
                        // Configure data labels plugin
                        datalabels: {
                            color: '#333',
                            font: {
                                weight: 'bold',
                                size: isMobile ? 10 : 12
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: (translations[currentLang].pieces || '件数') + ' (万)',
                                font: {
                                    size: isMobile ? 12 : 14
                                }
                            },
                            ticks: {
                                callback: function (value) {
                                    // Display Y-axis labels in 万 with 1 decimal place
                                    return value.toFixed(1);
                                },
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].vehicle_count || '车次',
                                font: {
                                    size: isMobile ? 12 : 14
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            }
                        }
                    },
                    // Improve mobile interaction
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    // Adjust layout padding for data labels
                    layout: {
                        padding: {
                            top: isMobile ? 30 : 40,
                            right: isMobile ? 10 : 20,
                            bottom: isMobile ? 10 : 20,
                            left: isMobile ? 10 : 20
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Show message function
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;

            // Clear message after 3 seconds
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // Load new charts on page load
        window.addEventListener('load', function () {
            loadDailyTrendData();
            loadWeekComparisonData();
            loadForecastVsActual();

            // Poll for updates every 30 seconds
            setInterval(loadForecastVsActual, 30000);
        });

        // Load forecast vs actual comparison data
        function loadForecastVsActual() {
            // console.log('Starting to load forecast vs actual data...');
            fetch('/api/forecast_vs_actual')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('Data received:', data);
                    if (!data || !data.dates || data.dates.length === 0) {
                        console.warn('No data received for forecast chart');
                        const canvas = document.getElementById('forecastVsActualChart');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.font = '14px Arial';
                            ctx.fillStyle = 'black';
                            ctx.fillText('暂无数据 / No Data', 10, 50);
                        }
                        return;
                    }
                    renderForecastVsActualChart(data);
                })
                .catch(error => {
                    console.error('Error loading forecast vs actual data:', error);
                    showMessage('Load Error: ' + error.message, 'error');
                });
        }

        // Render forecast vs actual comparison chart
        function renderForecastVsActualChart(data) {
            try {
                const canvas = document.getElementById('forecastVsActualChart');
                if (!canvas) {
                    console.error('Canvas element forecastVsActualChart not found');
                    return;
                }

                // Ensure canvas has size
                if (canvas.height === 0) canvas.height = 300;

                const ctx = canvas.getContext('2d');

                // Check if Chart is defined
                if (typeof Chart === 'undefined') {
                    throw new Error('Chart.js library not loaded');
                }

                // Update existing chart if it exists
                if (window.forecastChartInstance) {
                    window.forecastChartInstance.data.labels = data.dates;
                    window.forecastChartInstance.data.datasets[0].data = data.forecast;
                    window.forecastChartInstance.data.datasets[1].data = data.actual;
                    window.forecastChartInstance.data.datasets[2].data = data.difference_percent;
                    window.forecastChartInstance.update();
                    return;
                }

                // Create new chart
                window.forecastChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: translations[currentLang].forecast_value,
                                data: data.forecast,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                                order: 2
                            },
                            {
                                label: translations[currentLang].actual_value,
                                data: data.actual,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1,
                                yAxisID: 'y',
                                order: 1
                            },
                            {
                                label: translations[currentLang].difference_percent,
                                data: data.difference_percent,
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderWidth: 2,
                                yAxisID: 'y1',
                                tension: 0.3,
                                order: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].forecast_vs_actual_title
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            if (context.dataset.type === 'line') {
                                                label += context.parsed.y + '%';
                                            } else {
                                                label += context.parsed.y;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: translations[currentLang].pieces || '件数'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                grid: {
                                    drawOnChartArea: true, // Enable grid lines to draw the zero line
                                    color: function (context) {
                                        if (context.tick.value === 0) {
                                            return '#28a745'; // Green color for 0 line
                                        }
                                        return 'transparent'; // Hide other grid lines
                                    },
                                    lineWidth: function (context) {
                                        if (context.tick.value === 0) {
                                            return 2; // Thicker line for 0
                                        }
                                        return 0;
                                    }
                                },
                                title: {
                                    display: true,
                                    text: translations[currentLang].difference_percent + ' (%)'
                                }
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Render Chart Error:', err);
                showMessage('Render Chart Error: ' + err.message, 'error');
            }
        }

    </script>
</body>

</html>